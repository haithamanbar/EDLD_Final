---
title             : "Relations between Inflammation, access to care and Diabetes in two repesentative populations of China and Mexico."
shorttitle        : "Inflammation, access to care and Diabetes in China and Mexico."

author: 
  - name          : "Dominik Gr√§tz"
    affiliation   : "1"
    email         : "dgrtz@uoregon.edu"
  - name          : "Rachel Miller-Moudgil"
    affiliation   : "1"
    email         : "rmillerm@uoregon.edu"
  - name          : "Amber Somarriba"
    affiliation   : "1"
    email         : "asomarri@uoregon.edu"
  - name          : "Brittany Spinner"
    affiliation   : "1"
    email         : "bspinner@uoregon.edu"
  - name          : "Tian Walker"
    affiliation   : "1"
    email         : "twalker@uoregon.edu"

affiliation:
  - id            : "1"
    institution   : "University of Oregon"
    
authornote: "List of group members ordered by alphabet."

abstract: "*Background.* Background goes here. *Methods.* Methods go here. *Results.* Results here. *Conclusions.* Conclusions here."

keywords          : "Diabetes, access to care, inflammation, health, Mexico, China"
wordcount         : "X (this cannot easily be done automatically, we can also just leave it out)"

bibliography      : ["../r-references.bib"]

floatsintext      : yes
figurelist        : yes
tablelist         : yes
footnotelist      : no
linenumbers       : no
mask              : no
draft             : no

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_pdf
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = FALSE, warning = FALSE, echo = FALSE)
library(tidyverse)
library(rio)
library(here)
library(papaja)
library(tidyr)
source(file = here("scripts", "report_p.R"))
```

```{r data-cleaning-tian, echo=FALSE, eval=FALSE}
#code used to create extracted data file - Mexico 
#Rachel's note: This does not need re-run, as this was Tian joining two Mexico datasets and renaming variables and outputting mexico_raw_dat.csv. We should leave the code here so Joe can see how much initial data cleaning she worked on.
#great idea #dg

mex_survey <- import("Mexico_IND.sav")

mex_bio <- import("MexicoLabData.csv")

mex_survey$id <- as.numeric(mex_survey$id)
mexico <- mex_survey %>%
  left_join(mex_bio, by = 'id')

mexico_raw_dat <- mexico %>% select(income, q4022,  sex = q0406 , q0407, hba1c, crp, q4023a, q4024, weight = q2507, height = q2506, waist = q2508, marriage = q0408, q2000:q2024) %>% rename(diagnosis = q4022, age = q0407, medication = q4023a, dt_exrcse = q4024)

write_csv(mexico_raw_dat, file = "mexico_raw_dat.csv")
```

```{r data-cleaning-rachel, echo=FALSE}
#Rachel's code to drop irrelevant variables, filter, and add a medication*dt_exrcse variable.

data <- import(here("data","mexico_raw_dat.csv")) %>% as_tibble #Importing the Mexico dataset
data <- data %>% select(sex, diagnosis, age, hba1c, crp, medication, dt_exrcse) %>% filter(age >=50 & (diagnosis == 2 | hba1c >6.5))  %>% as_tibble #Selecting only relevant variables, renaming for clarification, and filtering. Once we figure out where the access variable (Q5004) is, we can replace this with the code below.

#data <- data %>% select(sex, diagnosis, age, hba1c, crp, medication, dt_exrcse, q5004) %>% rename(access = q5004) %>% filter(age >=50, crp <5, hba1c >6.5)  %>% as_tibble #Variable q5004 is missing from this dataset. Need help understanding where it went.

data <- data %>% mutate(med_dt_exrcse = medication*dt_exrcse, .after=dt_exrcse) %>% mutate(med_dt_exrcse = dplyr::recode(med_dt_exrcse, '4' = "1", '1' = "2", '2' = "2")) #Adding a new column for people who both take medication AND diet and exercise. 1 = yes for both, 2 = not yes for both

#making categorical variables factors
data <- data %>%
  mutate(sex = as.factor(sex),
         diagnosis = as.factor(diagnosis),
         medication = as.factor(medication),
         dt_exrcse = as.factor(dt_exrcse),
         med_dt_exrcse = as.factor(med_dt_exrcse))

#For our own sanity, this is a mini dataframe of variable descriptions and their coding criteria (if applicable).
col1 <- c("sex","diagnosis","age","hba1c","crp","medication","dt_exrcse","med_dt_exrcse","access")
col2 <- c("participant gender as reported by researcher (male = 1, female = 2)","whether the participant has been diagnosed with diabetes (yes = 1, no = 2)","participant age","participant blood sugar level","participant inflammation level","whether the participant is currently taking medication for diabetes inflammation (yes = 1, no = 2)","whether the participant is on a diabetes-specific diet and exercise plan (yes = 1, no = 2)","whether the participant is on BOTH medication and a diet and exercise plan (yes = 1, no = 2)","participant access to healthcare, i.e., to whom they typically go for healthcare (coding TBD)")
data_variables <- data.frame(col1, col2)

```

```{r pivot-by-sex, echo=FALSE}
#Code to investigate crp levels by sex. This is just to fulfill Joe's requirement of using one of the pivot commands.

data_by_sex <- data %>% pivot_wider(names_from="sex", values_from="crp") %>% rename(male="1",female="2") %>% as_tibble

```

```{r RQ1}
#RQ1: Does taking medication lower inflammation levels? (Requires filtering, modeling, a table, and a figure. Do only as much as possible in this timeframe!)


```

```{r RQ2, echo=FALSE, render = 'normal print'}
#RQ2: Does diet and exercise predict inflammation levels? (Requires filtering, modeling, a table, and a figure. Do only as much as possible in this timeframe!)
RQ2_df <- data %>%
  filter(!is.na(dt_exrcse) & !is.na(hba1c) & !is.na(age), !(is.na(crp)))
mreg2 <- lm(crp ~ hba1c * dt_exrcse + age, data = data)
mreg2_plot <- ggplot(data, aes(dt_exrcse, hba1c, age)) +         
  geom_point() +                                     
  stat_smooth(method = "lm",
              formula = mreg2,
              geom = "smooth") +
  facet_wrap(~dt_exrcse) +
  theme_classic()
summary(mreg2)

mreg2_summary <- summary(mreg2)
table2 <- apa_print(mreg2)
table2$table$predictor <- c('Intercept',
                            'Hba1c',
                            'dt_exrcse2',
                            'age',
                            'hba1c:dt_exrcse2')
```

```{r RQ3}
#RQ3: For those with vs. without access to medical care, what is the effect of diet and exercise on inflammation levels? (Requires filtering, modeling, a table, and a figure. Do only as much as possible in this timeframe!)

```


```{r descriptives table prep}
summary <- data %>%
  summarize(country = "Mexico",
            N = n(),
            N_male = sum(sex == 1, na.rm = TRUE), #1 is male
            N_male_pct = round((N_male/N*100), 1),
            N_female = sum(sex == 2, na.rm = TRUE),
            N_female_pct = round((N_female/N)*100, 1),
            N_unknown = sum(is.na(sex)),
            N_unknown_pct = round((N_unknown/N)*100, 1),
            diabetes_diag = sum(diagnosis == 1, na.rm = TRUE),
            diabetes_diag_pct = round((diabetes_diag/N)*100, 1),
            diabetes_undiag = sum(hba1c >= 6.5 & diagnosis == 2, na.rm = TRUE),
            diabetes_undiag_pct = round((diabetes_undiag/N)*100, 1),
            age_M = round(mean(age), 1),
            age_SD = round(sd(age), 1))
```

The descriptive statistics for our sample look as follows:

|  |            |`r summary$country[1]` |
|:-|:-----------|:----------------------|
|$N_{total}$|           |`r summary$N[1]`                                                     |
|Sex        |           |                                                                     |
|           |male       |`r summary$N_male[1]` (`r summary$N_male_pct[1]` %)                  |
|           |female     |`r summary$N_female[1]` (`r summary$N_female_pct[1]` %)              |
|           |unknown    |`r summary$N_unknown[1]` (`r summary$N_unknown_pct[1]` %)            |
|Age        |           |`r summary$age_M[1]` ($SD$ = `r summary$age_SD[1]`)                  |
|Diabetes   |           |                                                                     |
|           |diagnosed  |`r summary$diabetes_diag[1]` (`r summary$diabetes_diag_pct[1]` %)    |
|           |undiagnosed|`r summary$diabetes_undiag[1]` (`r summary$diabetes_undiag_pct[1]` %)|
Table: Descriptive statistics.

